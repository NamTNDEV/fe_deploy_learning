name: '::: CI/CD Pipeline :::'

on:
  push:
    branches: ['main']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: '::: 🛎️ Checkout :::'
        uses: actions/checkout@v4
      - name: '::: Create .env file :::'
        run: echo "${{ secrets.ENV }}" > .env
      - name: '::: 🔖 Generate short SHA :::'
        id: short_sha
        run: echo "SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
      - name: '::: 🐳 Build Docker image :::'
        run: docker build -t fe_deploy_learning .
      - name: '::: 🔑 Login to Docker Hub :::'
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
      - name: '::: 🔖 Tag Docker image :::'
        run: docker tag fe_deploy_learning namudp0301/fe_deploy_learning:${{ steps.short_sha.outputs.SHA }}
      - name: '::: 🚀 Push Docker image :::'
        run: docker push namudp0301/fe_deploy_learning:${{ steps.short_sha.outputs.SHA }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: '::: Connect to VPS & Deploy :::'
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            docker pull namudp0301/fe_deploy_learning:${{ needs.build.outputs.SHA }}
            docker stop fe_deploy_learning
            docker rm fe_deploy_learning
            docker run -d -p 4200:3000 --name fe_deploy_learning namudp0301/fe_deploy_learning:${{ needs.build.outputs.SHA }}
